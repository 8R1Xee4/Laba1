#include "mainwindow.h"
#include "ui_mainwindow.h"   // generated by AUTOUIC

MainWindow::MainWindow(QWidget *parent)
    : QMainWindow(parent),
      ui(new Ui::MainWindow)
  {
    initializeLogHandler();
    initializeMainWindow();
    initializeMainMenu();
    initializeApp();
    initializeStack();
    initializeMenuBar();

    connectMainMenu();
    connectApp();
  }

MainWindow::~MainWindow()
  {
    delete ui;
  }

// ----------------------------------------------

void MainWindow::initializeLogHandler()
{
  logHandler.addFile(QString("logs/") + QDateTime::currentDateTime().toString("yyyy-MM-dd_hh.mm.ss.log"));
  logHandler.addTextStream(*(new QTextStream(stdout)));
  qInstallMessageHandler(&LogHandler::messageHandler);
  qDebug(logInfo()) << "LogHandler initialized.";
}

void MainWindow::initializeMainWindow()
{
  ui->setupUi(this);
  this->setWindowTitle(appName);
  canClose = 1;
  modified = 0;
  qDebug(logInfo()) << "Main window initialized.";
}

void MainWindow::initializeMainMenu()
{
  menu = new MainMenu(this);
  menu->addButton("start");
  menu->addButton("info");
  menu->addButton("exit");
  menu->show();
  qDebug(logInfo()) << "Main menu initialized.";
}

void MainWindow::initializeStack()
{
  stack = new QStackedWidget(this);
  stack->addWidget(menu);
  stack->addWidget(app);
  stack->setCurrentIndex(0);
  this->setCentralWidget(stack);
  qDebug(logInfo()) << "Widget stack initialized.";
}

void MainWindow::initializeMenuBar()
{
  // --- File Menu ---
  fileMenu = menuBar()->addMenu(tr("&File"));
  newFileAct  = fileMenu->addAction(tr("&New"), QKeySequence::New, this, &MainWindow::slotNewFileAct);
  openFileAct = fileMenu->addAction(tr("&Open…"), QKeySequence::Open, this, &MainWindow::slotOpenFileAct);
  saveFileAct = fileMenu->addAction(tr("&Save"), QKeySequence::Save, this, &MainWindow::slotSaveFileAct);
  saveFileAsAct = fileMenu->addAction(tr("&Save as…"), QKeySequence::SaveAs, this, &MainWindow::slotSaveFileAsAct);
  fileMenu->addSeparator();
  exitAct     = fileMenu->addAction(tr("E&xit"), QKeySequence::Quit, this, &MainWindow::slotExitAct);

  // --- Edit Menu ---
  editMenu = menuBar()->addMenu(tr("&Edit"));
  undoAct  = editMenu->addAction(tr("&Undo"), QKeySequence::Undo, this, &MainWindow::slotUndoAct);
  redoAct  = editMenu->addAction(tr("&Redo"), QKeySequence::Redo, this, &MainWindow::slotRedoAct);
  editMenu->addSeparator();
  cutAct   = editMenu->addAction(tr("Cu&t"), QKeySequence::Cut, this, &MainWindow::slotCutAct);
  pasteAct = editMenu->addAction(tr("&Paste"), QKeySequence::Paste, this, &MainWindow::slotPasteAct);

  // --- Help Menu ---
  helpMenu = menuBar()->addMenu(tr("&Help"));
  aboutAct = helpMenu->addAction(tr("&About"), this, &MainWindow::slotAboutAct);
  
  menuBar()->hide();
  qDebug(logInfo()) << "Menu bar initialized.";
}

// Need work
void MainWindow::initializeApp()
{
  app = new QWidget(this);
  // ...
  qDebug(logInfo()) << "App initialized.";
}

// -------------------------------------------------

void MainWindow::connectMainMenu()
{
  QVector<QPushButton*>& b = menu->getButtons();
  connect(b[0], &QPushButton::clicked, this, &MainWindow::slotStartButton);
  connect(b[1], &QPushButton::clicked, this, &MainWindow::slotInfoButton);
  connect(b[2], &QPushButton::clicked, this, &MainWindow::slotExitButton);
  qDebug(logInfo()) << "Main menu connected.";
}

// Need work
void MainWindow::connectApp()
{
  // ...
  qDebug(logInfo()) << "App connected.";
}

// ---------------------------------------------

void MainWindow::slotStartButton()
{
  qDebug(logInfo()) << "User pressed start button (main menu).";
  stack->setCurrentIndex(1);
  menuBar()->show();
  setWindowTitle(tr("Untitled - ") + appName);
  modified = 1;
}

void MainWindow::slotInfoButton()
{
  qDebug(logInfo()) << "User pressed info button (main menu).";
  showAppInfo();
}

void MainWindow::slotExitButton()
{
  qDebug(logInfo()) << "User pressed exit button (main menu).";
  onExit();
  this->close();
}

// ------------------------------------------------------------
// File menu slots
void MainWindow::slotNewFileAct()
{
  qDebug(logInfo()) << "New file action called.";
  if (!maybeSave())
    return;                     // user cancelled

  //textEdit->clear();
  //textEdit->document()->setModified(false);
  modified = 1;

  currentFile.clear();
  setWindowTitle(tr("Untitled - ") + appName);
  qDebug(logInfo()) << "New document created.";
}

//–– Save (Save or Save As) ––
void MainWindow::slotSaveFileAct()
{
  qDebug(logInfo()) << "Save file action called.";
  if (saveFile())
    qDebug(logInfo()) << "Document saved.";
  else
    qDebug(logWarning()) << "Save cancelled or failed.";
}

void MainWindow::slotSaveFileAsAct()
{
  qDebug(logInfo()) << "Save file as action called.";
  if(saveFileAs())
  {
    qDebug(logInfo()) << "Saved successfully.";
  } else qDebug(logWarning()) << "Couldn't save as.";
}

//–– ask Save As ––
bool MainWindow::saveFileAs()
{
  QString fn = QFileDialog::getSaveFileName(this, tr("Save As"), QString(), tr("Text Files (*.txt);;All Files (*)"));
  if (fn.isEmpty())
    return false;

  return saveToFile(fn);
}

//–– Save currentFile, or fall back to Save As ––
bool MainWindow::saveFile()
{
  if (currentFile.isEmpty())
    return saveFileAs();
  return saveToFile(currentFile);
}

//–– Actual disk write ––
bool MainWindow::saveToFile(const QString &fileName)
{
  qDebug(logInfo()) << "Trying to save to " << fileName;
  QFile file(fileName);
  if (!file.open(QFile::WriteOnly | QFile::Text)) {
    QMessageBox::warning( this, tr("Error"), tr("Cannot write file %1:\n%2").arg(QDir::toNativeSeparators(fileName), file.errorString()));
    qDebug(logWarning) << "Cannot write file: " << fileName;
    return false;
  }

  QTextStream out(&file);
  //out << textEdit->toPlainText();
  file.close();

  currentFile = fileName;
  modified = 0;
  //textEdit->document()->setModified(false);
  setWindowTitle(QFileInfo(currentFile).fileName() + tr(" - ") + appName);
  return true;
}

//–– Prompt the user to save if the document is dirty ––
bool MainWindow::maybeSave()
{
  //if (!textEdit->document()->isModified())
  //  modified = 1;

  if(!modified)
    return true;
  qDebug(logInfo()) << "Asking user to save.";

  auto ret = QMessageBox::warning(
    this,
    appName,
    tr("The document has been modified.\nDo you want to save your changes?"),
    QMessageBox::Save | QMessageBox::Discard | QMessageBox::Cancel, QMessageBox::Save
  );

  switch (ret) {
    case QMessageBox::Save:
      return saveFile();
    case QMessageBox::Cancel:
      return false;
    default: // Discard
      return true;
  }
}

void MainWindow::slotExitAct()
{
  qDebug(logInfo()) << "Exit action.";
  this->close();
}

void MainWindow::slotOpenFileAct()
{
  qDebug(logInfo()) << "Open file action called.";
  QString path = QFileDialog::getOpenFileName(this, tr("Open File"), QString(), tr("Text Files (*.txt);;All Files (*)"));
  if(path.isEmpty()) return;

  QFile f(path);
  if(!f.open(QIODevice::ReadOnly | QIODevice::Text)){
    QMessageBox::warning(this, tr("Error"), tr("Cannot open file %1").arg(path));
    qDebug(logWarning()) << "Couldn't open file: " << path;
    return;
  }
  QTextStream in(&f);
  // ...
  f.close();
  qDebug(logInfo()) << "Opened: " << path;
}

// ---------------------------------------------
// Edit menu slots

void MainWindow::slotUndoAct()   
{ 
  qDebug(logInfo()) << "Undo action.";
  // textEdit->undo(); 
}
void MainWindow::slotRedoAct()   
{ 
  qDebug(logInfo()) << "Redo action.";
  // textEdit->redo(); 
}
void MainWindow::slotCutAct()    
{ 
  qDebug(logInfo()) << "Cut action.";
  // textEdit->cut(); 
}
void MainWindow::slotPasteAct()  
{ 
  qDebug(logInfo()) << "Paste action.";
  // textEdit->paste(); 
}

// ---------------------------------------------
// Help menu slot

void MainWindow::slotAboutAct()
{
  qDebug(logInfo()) << "About action.";
  showAppInfo();
}


// ------------------------------------------------------------

void MainWindow::closeEvent(QCloseEvent *event)
{
  qDebug(logInfo()) << "Close event called.";
  maybeSave();
  if (canClose) {
    onExit();
    qDebug(logInfo()) << "Closing in action.";
    event->accept();
  } else {
    qDebug(logInfo()) << "Closing ignored.";
    event->ignore();
  }
}

// ---------------------------------------------------------------

void MainWindow::onExit()
{
  qDebug(logInfo()) << "On exit event called.";
}

void MainWindow::showAppInfo()
{
  qDebug(logInfo()) << "Dialog called.";
  InfoDialog* dlg = new InfoDialog(this);
  dlg->show();
}