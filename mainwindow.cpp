#include "mainwindow.h"
#include "ui_mainwindow.h"   // generated by AUTOUIC

MainWindow::MainWindow(QWidget *parent)
  : QMainWindow(parent),
    ui(new Ui::MainWindow)
{
  initializeLogHandler();
  initializeMainWindow();
  initializeMainMenu();
  initializeMenuBar();
  initializeApp();
  initializeStack();

  connectMainMenu();
  connectApp();
}

MainWindow::~MainWindow()
{
  delete ui;
}

// ----------------------------------------------

void MainWindow::initializeLogHandler()
{
  logHandler.addFile(QString("logs/") + QDateTime::currentDateTime().toString("yyyy-MM-dd_hh.mm.ss.log"));
  logHandler.addTextStream(*(new QTextStream(stdout)));
  qInstallMessageHandler(&LogHandler::messageHandler);
  qDebug(logInfo()) << "LogHandler initialized.";
}

void MainWindow::initializeMainWindow()
{
  ui->setupUi(this);
  canClose = 1;
  qDebug(logInfo()) << "Main window initialized.";
}

void MainWindow::initializeMainMenu()
{
  menu = new MainMenu(this);
  menu->addButton("start");
  menu->addButton("info");
  menu->addButton("exit");
  menu->show();
  qDebug(logInfo()) << "Main menu initialized.";
}

void MainWindow::initializeStack()
{
  stack = new QStackedWidget(this);
  stack->addWidget(menu);
  stack->addWidget(app);
  stack->setCurrentIndex(0);
  this->setCentralWidget(stack);
  qDebug(logInfo()) << "Widget stack initialized.";
}

// Need work
void MainWindow::initializeMenuBar()
{
  // ...
  menuBar()->hide();
  qDebug(logInfo()) << "Menu bar initialized.";
}

// Need work
void MainWindow::initializeApp()
{
  app = new QWidget(this);
  // ...
  qDebug(logInfo()) << "App initialized.";
}

// -------------------------------------------------

void MainWindow::connectMainMenu()
{
  QVector<QPushButton*>& b = menu->getButtons();
  connect(b[0], &QPushButton::clicked, this, &MainWindow::slotStartButton);
  connect(b[1], &QPushButton::clicked, this, &MainWindow::slotInfoButton);
  connect(b[2], &QPushButton::clicked, this, &MainWindow::slotExitButton);
  qDebug(logInfo()) << "Main menu connected.";
}

// Need work
void MainWindow::connectApp()
{
  // ...
  qDebug(logInfo()) << "App connected.";
}

// ---------------------------------------------

void MainWindow::slotStartButton()
{
  qDebug(logInfo()) << "User pressed start button (main menu).";
  stack->setCurrentIndex(1);
  menuBar()->show();
}

void MainWindow::slotInfoButton()
{
  qDebug(logInfo()) << "User pressed info button (main menu).";
  showAppInfo();
}

void MainWindow::slotExitButton()
{
  qDebug(logInfo()) << "User pressed exit button (main menu).";
  onExit();
  this->close();
}

// ------------------------------------------------------------

void MainWindow::closeEvent(QCloseEvent *event)
{
  qDebug(logInfo()) << "Closing application...";
  if (canClose) {
    onExit();
    qDebug(logInfo()) << "Closing in action.";
    event->accept();
  } else {
    qDebug(logInfo()) << "Closing ignored.";
    event->ignore();
  }
}

// ---------------------------------------------------------------

void MainWindow::onExit()
{
  qDebug(logInfo()) << "On exit event called.";
}

void MainWindow::showAppInfo()
{
  qDebug(logInfo()) << "Dialog called.";
  InfoDialog* dlg = new InfoDialog(this);
  dlg->show();
}